
import os
import datetime
import uno
from com.sun.star.text.ControlCharacter import PARAGRAPH_BREAK
from com.sun.star.text.TextContentAnchorType import AS_CHARACTER

nmap_output_dir = '/home/kali'
descriptions_file = '/home/kali/description.txt'
libreoffice_template = 'file:////home/kali/Documents/template.odt'

nmap_files = [os.path.join(nmap_output_dir, f) for f in os.listdir(nmap_output_dir) if f.startswith('nmap_results_')]
latest_nmap_output_file = max(nmap_files, key=os.path.getmtime)

descriptions = { '1': '', '2': ''}

with open(descriptions_file, 'r') as file:
    for line in file:
        if line.startswith('1'):
            descriptions['1'] = line[1:].strip()
        elif line.startswith('2'):
            descriptions['2'] = line[1:].strip()

with open(latest_nmap_output_file, 'r') as file:
    nmap_content = file.read()
    if "smtp-strangeport" in nmap_content:
    	chosen_description = descriptions['2']
    	print("Description 2 was chosen: ", chosen_description)
    else:
    	chosen_description = descriptions['1']
    	print("Description 1 was chosen: ", chosen_description)
    	print(chosen_description)

local_context = uno.getComponentContext()
resolver = local_context.ServiceManager.createInstanceWithContext("com.sun.star.bridge.UnoUrlResolver", local_context)
context = resolver.resolve("uno:socket,host=localhost,port=2002;urp;StarOffice.ComponentContext")
desktop = context.ServiceManager.createInstanceWithContext("com.sun.star.frame.Desktop", context)

doc = desktop.loadComponentFromURL(libreoffice_template, "_blank", 0, ())

def insert_text_at_bookmark(doc, bookmark_name, text):
    text_range = doc.getBookmarks().getByName(bookmark_name).getAnchor()
    cursor = text_range.getText().createTextCursorByRange(text_range)
    cursor.setString(text)

insert_text_at_bookmark(doc, "description", chosen_description)

with open(latest_nmap_output_file, 'r') as file:
    lines = file.readlines()

total_ports = sum(1 for line in lines if "smtp-strangeport" in line)
insert_text_at_bookmark(doc, "tp", str(total_ports))

port_number = 1
for index, line in enumerate(lines):
    if "smtp-strangeport" in line and index > 0:  # Check to avoid index error
        port_info_line = lines[index - 1]  # The line above "smtp-strangeport"
        bookmark_name = f"port{port_number}"
        insert_text_at_bookmark(doc, bookmark_name, port_info_line.strip())
        port_number += 1

filename = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
doc.storeAsURL(f"file:///home/kali/Documents/{filename}.odt", ())

doc.dispose()
